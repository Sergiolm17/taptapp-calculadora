---
import Nav from '../components/Nav.astro';
import "../styles/global.css";

---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costos de Impresión PDF</title>
</head>
<body class="bg-gray-100 m-0">
    <Nav />
    <div class="max-w-3xl mx-auto px-4 py-4 sm:py-6">
        <div class="bg-white p-4 sm:p-8 rounded-lg shadow-md">
            <h1 class="text-2xl sm:text-3xl text-gray-800 mb-4 sm:mb-6 text-center">Calculadora de Costos de Impresión PDF</h1>
            
            <div class="text-center my-4 sm:my-8">
                <label for="pdfInput" class="block w-full max-w-xs mx-auto bg-blue-500 text-white px-3 py-2 sm:px-6 sm:py-3 rounded-md cursor-pointer hover:bg-blue-600 transition-colors text-center">
                    Elegir archivo PDF
                    <input
                        type="file" 
                        id="pdfInput" 
                        accept="application/pdf"
                        class="hidden"
                    >
                </label>
                <div id="fileName" class="mt-2 text-sm text-gray-600"></div>
                <div id="loading" class="hidden text-gray-600 mt-4">Procesando PDF...</div>
            </div>

            <div id="pdfContainer" class="flex flex-col items-center">
                <div id="pdfPreview" class="w-full my-4 sm:my-6 flex justify-center">
                    <canvas id="pdfCanvas" class="border-2 border-gray-200 rounded-lg p-2 bg-white"></canvas>
                </div>
                
                <div class="flex justify-between items-center mb-4 gap-2 w-full max-w-md">
                    <button id="prevPage" class="bg-gray-300 px-2 py-1 sm:px-4 sm:py-2 rounded-md disabled:opacity-50 text-sm sm:text-base">Anterior</button>
                    <div id="pageInfo" class="text-gray-700 text-sm sm:text-base">Página 0 de 0</div>
                    <button id="nextPage" class="bg-gray-300 px-2 py-1 sm:px-4 sm:py-2 rounded-md disabled:opacity-50 text-sm sm:text-base">Siguiente</button>
                </div>
            </div>

            <div id="results" class="bg-gray-50 p-3 sm:p-6 rounded-lg mt-4 sm:mt-8 hidden">
                <h2 class="text-xl sm:text-2xl text-gray-800 mb-4 sm:mb-6">Resultados del análisis</h2>
                <p id="pagesInfo" class="mb-3 sm:mb-4 text-sm sm:text-base">Número de páginas: <span id="pageCount">0</span></p>
                
                <!-- Resumen visual de costos por tinta -->
                <div id="inkCostSummary" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6"></div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden text-sm sm:text-base">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-1 px-2 sm:py-2 sm:px-4 border-b">Página</th>
                                <th class="py-1 px-2 sm:py-2 sm:px-4 border-b">Cian %</th>
                                <th class="py-1 px-2 sm:py-2 sm:px-4 border-b">Magenta %</th>
                                <th class="py-1 px-2 sm:py-2 sm:px-4 border-b">Amarillo %</th>
                                <th class="py-1 px-2 sm:py-2 sm:px-4 border-b">Negro %</th>
                                <th class="py-1 px-2 sm:py-2 sm:px-4 border-b">Costo</th>
                            </tr>
                        </thead>
                        <tbody id="pageResultsBody">
                            <!-- Los resultados por página se mostrarán aquí -->
                        </tbody>
                    </table>
                </div>
                
                <div id="totalCostResult" class="text-xl sm:text-2xl text-green-600 font-bold text-center my-3 sm:my-5"></div>
                <div class="text-xs sm:text-sm text-gray-500 mt-3 sm:mt-5">
                    * Cálculo basado en consumo de tóner donde 450g a 5% de cobertura rinde 60000 páginas y costo de S/130 por 400g de tóner
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir PDF.js -->
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script is:inline>
        // Configurar PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Valores predeterminados en caso de que no haya configuración guardada
        const DEFAULT_SETTINGS = {
            tonerPrice: 130,
            tonerWeight: 400,
            tonerYield: 60000,
            coveragePercent: 5,
            tonerYieldWeight: 450
        };
        
        // Calcular constantes a partir de la configuración
        let TONER_COST_PER_GRAM;
        let GRAMS_PER_PAGE_PER_20_PERCENT;
        
        // Área de referencia A4 en puntos (72 puntos por pulgada)
        const A4_AREA_POINTS = (8.27 * 11.69) * (72 * 72); // A4 en pulgadas * puntos por pulgada al cuadrado
        
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let canvas = document.getElementById('pdfCanvas');
        let ctx = canvas.getContext('2d');
        let pageResults = [];
        let currentScale = 1.5;
        let totalInkCosts = {
            cyan: 0,
            magenta: 0,
            yellow: 0,
            black: 0
        };

        // Cargar configuración desde localStorage
        function loadSettings() {
            let settings;
            try {
                const savedSettings = localStorage.getItem('taptappSettings');
                settings = savedSettings ? JSON.parse(savedSettings) : DEFAULT_SETTINGS;
            } catch (e) {
                console.error('Error al cargar la configuración:', e);
                settings = DEFAULT_SETTINGS;
            }
            
            // Calcular las constantes utilizadas en los cálculos
            TONER_COST_PER_GRAM = settings.tonerPrice / settings.tonerWeight;
            const gramsPerPageAtCoverage = settings.tonerYieldWeight / settings.tonerYield;
            GRAMS_PER_PAGE_PER_20_PERCENT = gramsPerPageAtCoverage * (20 / settings.coveragePercent);
            
            // Actualizar texto explicativo
            const explanationText = document.querySelector('.text-xs.sm\\:text-sm.text-gray-500');
            if (explanationText) {
                explanationText.textContent = `* Cálculo basado en consumo de tóner donde ${settings.tonerYieldWeight}g a ${settings.coveragePercent}% de cobertura rinde ${settings.tonerYield} páginas y costo de S/${settings.tonerPrice} por ${settings.tonerWeight}g de tóner`;
            }
        }
        
        // Cargar configuración al inicio
        loadSettings();

        // Ajustar tamaño del canvas cuando cambia el tamaño de la ventana
        function resizeCanvas() {
            if (pdfDoc) {
                // Volver a renderizar la página actual con escala ajustada
                renderPage(pageNum);
            }
        }

        // Manejar la selección de archivo y mostrar el nombre
        document.getElementById('pdfInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Mostrar nombre del archivo
            document.getElementById('fileName').textContent = file.name;
            
            // Mostrar contenedor del PDF
            document.getElementById('pdfContainer').style.display = 'flex';
            
            const reader = new FileReader();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            pageResults = [];
            // Reiniciar costos de tinta totales
            totalInkCosts = {
                cyan: 0,
                magenta: 0,
                yellow: 0,
                black: 0
            };

            reader.onload = function(event) {
                const typedarray = new Uint8Array(event.target.result);
                loadPdfDocument(typedarray);
            };
            reader.readAsArrayBuffer(file);
        });

        function loadPdfDocument(typedarray) {
            pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                pdfDoc = pdf;
                document.getElementById('pageInfo').textContent = `Página ${pageNum} de ${pdfDoc.numPages}`;
                document.getElementById('pageCount').textContent = pdfDoc.numPages;
                
                // Analizar todas las páginas
                analyzeAllPages().then(() => {
                    // Mostrar la primera página
                    renderPage(pageNum);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    
                    // Mostrar resultados
                    showResults();
                });
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Error al cargar el PDF. Por favor, intenta con otro archivo.');
            });
        }

        async function analyzeAllPages() {
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                await pdfDoc.getPage(i).then(function(page) {
                    const viewport = page.getViewport({ scale: 1.0 });
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Calcular el área real de la página en puntos
                    const pageArea = viewport.width * viewport.height;
                    // Factor de escala basado en el área relativa a un A4
                    const areaScaleFactor = pageArea / A4_AREA_POINTS;
                    
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    
                    return page.render({
                        canvasContext: tempCtx,
                        viewport: viewport
                    }).promise.then(function() {
                        const coverage = calculateCoverage(tempCanvas);
                        const cost = calculateCost(coverage, areaScaleFactor);
                        
                        // Acumular costos de tinta
                        totalInkCosts.cyan += cost.cyan;
                        totalInkCosts.magenta += cost.magenta;
                        totalInkCosts.yellow += cost.yellow;
                        totalInkCosts.black += cost.black;
                        
                        pageResults.push({
                            pageNum: i,
                            coverage,
                            cost,
                            dimensions: {
                                width: viewport.width,
                                height: viewport.height,
                                area: pageArea,
                                scaleFactor: areaScaleFactor
                            }
                        });
                    });
                });
            }
        }

        function calculateScaleForViewport() {
            // Obtener el ancho disponible para el canvas (ancho del contenedor menos padding)
            const containerWidth = document.getElementById('pdfPreview').clientWidth - 20;
            const scale = containerWidth < 768 ? 0.9 : 1.2;
            return Math.min(scale, containerWidth / 650); // Limitar escala para que quepa en el contenedor
        }

        function renderPage(num) {
            pageRendering = true;
            
            pdfDoc.getPage(num).then(function(page) {
                currentScale = calculateScaleForViewport();
                const viewport = page.getViewport({ scale: currentScale });
                
                // Ajustar dimensiones del canvas
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(function() {
                    pageRendering = false;
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
                
                document.getElementById('pageInfo').textContent = `Página ${num} de ${pdfDoc.numPages}`;
                
                // Actualizar botones
                document.getElementById('prevPage').disabled = num <= 1;
                document.getElementById('nextPage').disabled = num >= pdfDoc.numPages;
            });
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        document.getElementById('prevPage').addEventListener('click', function() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        document.getElementById('nextPage').addEventListener('click', function() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        function calculateCoverage(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            let cTotal = 0, mTotal = 0, yTotal = 0, kTotal = 0;
            const pixelCount = canvas.width * canvas.height;

            for(let i = 0; i < data.length; i += 4) {
                const r = data[i]/255;
                const g = data[i+1]/255;
                const b = data[i+2]/255;
                const a = data[i+3]/255;

                // Si el píxel es transparente, no lo contamos
                if (a < 0.1) continue;

                // Conversión RGB a CMYK
                const k = 1 - Math.max(r, g, b);
                const c = k === 1 ? 0 : (1 - r - k)/(1 - k);
                const m = k === 1 ? 0 : (1 - g - k)/(1 - k);
                const y = k === 1 ? 0 : (1 - b - k)/(1 - k);

                cTotal += c;
                mTotal += m;
                yTotal += y;
                kTotal += k;
            }

            return {
                cyan: (cTotal/pixelCount) * 100,
                magenta: (mTotal/pixelCount) * 100,
                yellow: (yTotal/pixelCount) * 100,
                black: (kTotal/pixelCount) * 100
            };
        }

        function calculateCost(coverage, areaScaleFactor = 1) {
            const costPerColor = (percentage) => 
                (percentage/20) * GRAMS_PER_PAGE_PER_20_PERCENT * TONER_COST_PER_GRAM * areaScaleFactor;
            
            return {
                cyan: costPerColor(coverage.cyan),
                magenta: costPerColor(coverage.magenta),
                yellow: costPerColor(coverage.yellow),
                black: costPerColor(coverage.black),
                total: Object.values(coverage).reduce((acc, val) => acc + costPerColor(val), 0)
            };
        }

        function showResults() {
            const tableBody = document.getElementById('pageResultsBody');
            tableBody.innerHTML = '';
            
            let totalCost = 0;
            
            pageResults.forEach(result => {
                const row = document.createElement('tr');
                
                // Añadir celdas a la fila
                const cellClasses = 'py-1 px-2 sm:py-2 sm:px-4 border-b text-center';
                
                // Página y dimensiones
                const pageCell = document.createElement('td');
                pageCell.className = cellClasses;
                const widthMm = (result.dimensions.width / 72) * 25.4;
                const heightMm = (result.dimensions.height / 72) * 25.4;
                pageCell.textContent = `${result.pageNum} (${widthMm.toFixed(0)}×${heightMm.toFixed(0)}mm)`;
                row.appendChild(pageCell);
                
                // Cian
                const cyanCell = document.createElement('td');
                cyanCell.className = cellClasses;
                cyanCell.textContent = result.coverage.cyan.toFixed(1);
                row.appendChild(cyanCell);
                
                // Magenta
                const magentaCell = document.createElement('td');
                magentaCell.className = cellClasses;
                magentaCell.textContent = result.coverage.magenta.toFixed(1);
                row.appendChild(magentaCell);
                
                // Amarillo
                const yellowCell = document.createElement('td');
                yellowCell.className = cellClasses;
                yellowCell.textContent = result.coverage.yellow.toFixed(1);
                row.appendChild(yellowCell);
                
                // Negro
                const blackCell = document.createElement('td');
                blackCell.className = cellClasses;
                blackCell.textContent = result.coverage.black.toFixed(1);
                row.appendChild(blackCell);
                
                // Costo
                const costCell = document.createElement('td');
                costCell.className = cellClasses;
                costCell.textContent = `S/${result.cost.total.toFixed(3)}`;
                row.appendChild(costCell);
                
                tableBody.appendChild(row);
                totalCost += result.cost.total;
            });
            
            // Mostrar resumen de costos por tinta
            showInkCostSummary();
            
            document.getElementById('totalCostResult').innerHTML = `
                Costo total del documento: S/${totalCost.toFixed(3)}
            `;
        }
        
        function showInkCostSummary() {
            const summaryContainer = document.getElementById('inkCostSummary');
            summaryContainer.innerHTML = `
                <div class="bg-cyan-500 text-white p-3 sm:p-4 rounded-md text-center font-bold flex flex-col justify-center">
                    <div class="text-base sm:text-lg">Cian</div>
                    <div class="text-lg sm:text-xl">S/${totalInkCosts.cyan.toFixed(2)}</div>
                </div>
                <div class="bg-fuchsia-500 text-white p-3 sm:p-4 rounded-md text-center font-bold flex flex-col justify-center">
                    <div class="text-base sm:text-lg">Magenta</div>
                    <div class="text-lg sm:text-xl">S/${totalInkCosts.magenta.toFixed(2)}</div>
                </div>
                <div class="bg-yellow-400 text-white p-3 sm:p-4 rounded-md text-center font-bold flex flex-col justify-center">
                    <div class="text-base sm:text-lg">Amarillo</div>
                    <div class="text-lg sm:text-xl">S/${totalInkCosts.yellow.toFixed(2)}</div>
                </div>
                <div class="bg-black text-white p-3 sm:p-4 rounded-md text-center font-bold flex flex-col justify-center">
                    <div class="text-base sm:text-lg">Negro</div>
                    <div class="text-lg sm:text-xl">S/${totalInkCosts.black.toFixed(2)}</div>
                </div>
            `;
        }

        // Inicialización y configuración
        document.addEventListener('DOMContentLoaded', function() {
            // Ocultar inicialmente el contenedor del PDF hasta que se seleccione un archivo
            if (!pdfDoc) {
                document.getElementById('pdfContainer').style.display = 'none';
            }
        });

        // Escuchar cambios de tamaño de la ventana para ajustar el canvas
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html> 